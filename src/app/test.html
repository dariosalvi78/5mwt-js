<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.rawgit.com/kimeiga/bahunya/css/bahunya-0.1.1.css" />
    <script src="deps/FileSaver.js"></script>
    <script src="phone/motion.js"></script>
</head>

<body>
    <h2 style="text-align: center;">5-minute walk test</h2>

    <main>
        <article>
            <h3 id="mainText"></h3>

            <section>
                <p id="subText"></p>
                <button id="startBtn">Start</button>
            </section>

        </article>
    </main>

</body>

<script>
    let startButton = document.getElementById('startBtn')
    let mainText = document.getElementById('mainText')
    let subText = document.getElementById('subText')

    // text of the instructions
    let instructions = {
        error: 'Error',
        intro1: 'Position yourself over the marked starting point and press "Start" when ready',
        wait: 'Please wait',
        start: 'Start',
        done: 'Done',
        restart: 'Restart',
        walk: 'Walk!',
        doneWhenDone: 'Press done when completed',
        intro2: 'Second round: turn around and press "Start" when ready to walk back',
        intro3: 'Last round: turn around again and press "Start" when ready to walk',
        completion: 'Test completed!',
        results: 'Average time: '
    }

    // state machine of the test
    let state = {
        current: 'intro1',
        reset () {
            this.current = 'intro1'
        },
        next () {
            switch (this.current) {
                case 'intro1':
                    this.current = 'wait1'
                    break;
                case 'wait1':
                    this.current = 'walk1'
                    break;
                case 'walk1':
                    this.current = 'intro2'
                    break;
                case 'intro2':
                    this.current = 'wait2'
                    break;
                case 'wait2':
                    this.current = 'walk2'
                    break;
                case 'walk2':
                    this.current = 'intro3'
                    break;
                case 'intro3':
                    this.current = 'wait3'
                    break;
                case 'wait3':
                    this.current = 'walk3'
                    break;
                case 'walk3':
                    this.current = 'completion'
                    break;
                case 'completion':
                    this.current = 'intro1'
                    break;
                default:
                    this.current = 'error'
            }
        }
    }

    // detect file saving capability
    try {
        new Blob
    } catch (e) {
        state.current = 'error'
        subText.innerHTML = 'File saving not supported'
    }

    updateTexts = function () {
        subText.innerHTML = ''
        switch (state.current) {
            case 'intro1':
                mainText.innerHTML = instructions.intro1
                break
            case 'wait1':
                mainText.innerHTML = mainText.innerHTML = instructions.wait + ` 5`
                break
            case 'walk1':
                mainText.innerHTML = instructions.walk
                subText.innerHTML = instructions.doneWhenDone
                break
            case 'intro2':
                mainText.innerHTML = instructions.intro2
                break
            case 'wait2':
                mainText.innerHTML = instructions.wait + ` 5`
                break
            case 'walk2':
                mainText.innerHTML = instructions.walk
                subText.innerHTML = instructions.doneWhenDone
                break
            case 'intro3':
                mainText.innerHTML = instructions.intro3
                break
            case 'wait3':
                mainText.innerHTML = instructions.wait + ` 5`
                break
            case 'walk3':
                mainText.innerHTML = instructions.walk
                subText.innerHTML = instructions.doneWhenDone
                break
            case 'completion':
                mainText.innerHTML = instructions.completion
                subText.innerHTML = instructions.results
                break
            default:
                mainText.innerHTML = ''
                subText.innerHTML = ''
        }
    }

    updateButton = function () {
        if (state.current == 'wait1' ||
            state.current == 'wait2' ||
            state.current == 'wait3') {
            startButton.innerHTML = '...'
            startButton.disabled = true
        }
        else if (state.current == 'intro1' ||
            state.current == 'intro2' ||
            state.current == 'intro3') {
            startButton.innerHTML = instructions.start
            startButton.disabled = false
        } else if (state.current == 'walk1' ||
            state.current == 'walk2' ||
            state.current == 'walk3') {
            startButton.innerHTML = instructions.done
            startButton.disabled = false
        } else if (state.current == 'completion') {
            startButton.innerHTML = instructions.restart
            startButton.disabled = false
        }
    }

    state.reset()
    updateTexts()
    updateButton()

    let testData = {}
    initData = function () {
        testData = {
            run1: {
                motion: [],
                orientation: []
            },
            run2: {
                motion: [],
                orientation: []
            },
            run3: {
                motion: [],
                orientation: []
            }
        }
    }

    startButton.addEventListener('click', () => {
        state.next()
        updateTexts()
        updateButton()
        if (state.current == 'wait1') {
            initData()
        }

        if (state.current == 'wait1' ||
            state.current == 'wait2' ||
            state.current == 'wait3') {
            // countdown
            let secs = 4
            let timer = setInterval(() => {
                mainText.innerHTML = instructions.wait + ` ${secs}`
                secs--
                if (secs == 0) {
                    // test started!
                    clearInterval(timer)

                    if (navigator.vibrate) {
                        navigator.vibrate(200)
                    }
                    state.next()
                    updateTexts()
                    updateButton()
                }
            }, 1000)

            // start acquiring signals
            motion.startNotifications((data) => {
                // store data
                if (state.current == 'wait1' || state.current == 'walk1')
                    testData.run1.motion.push(data)
                if (state.current == 'wait2' || state.current == 'walk2')
                    testData.run2.motion.push(data)
                if (state.current == 'wait3' || state.current == 'walk3')
                    testData.run3.motion.push(data)
            })
        } else if (state.current == 'walk1' ||
            state.current == 'walk2' ||
            state.current == 'walk3') {
            motion.stopNotifications()
        }

        if (state.current == 'completion') {
            var blob = new Blob([JSON.stringify(testData)], { type: "text/json;charset=utf-8" })
            saveAs(blob, "testresults.txt")
        }
    })
</script>

</html>